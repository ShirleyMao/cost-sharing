
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"> <!--name space-->

<head>
	<meta http-equiv="Content-Type" content="text/html"; charset="UTF-8" />  <!--tell broweser prepare to rececive a html document -->
	<link rel="stylesheet" type="text/css" href="c1.css" />
	<script type="text/javascript" src="common.js"></script>
	<title>Cost-Sharing</title>

</head>

<body>
<!--title-->
<div id="header">
	<h1>费用分摊</h1>
</div>

<!--navigator-->
<nav id="navigator">
	<div id="menuNav">
		<ul id="menu">
			<li id="item0"><a href="#item0">预付款</a></li>
		</ul>
	</div>
	<input  id="add" type="button" value="新增支出"/><!--需要补充href-->
	<input id="btnSubmit" form="info1" class="btnSubmit" type="submit" value="提交"/>

</nav>
<div id="infoBody" class="mainbody">
	<div id="anchclList0">
		<a name="item0"></a>
		<div class="mainbody" id="content1_0">
			<form id="info1" action="dealwith.asp" method="post"/>
				<input id="itemName0" class="inputdata" type="text" name="item" value="预付款"/>	总金额：
				<input id="pay0" class="inputdata" type="text" name="totalPay" />	总人数：  
				<input id="shareNum0" class="inputdata" type="text" name="userNum"/>
			</form>
		</div>

		<div class="mainbody" id="content2_0" >
			<table id="tableInfo0">
				<tr>
					<td>交款人</td>
					<td>电话</td>
					<td>邮箱</td>
					<td>实交款</td>
					<td>需交款</td>					
				</tr>
				<tr>
					<td><input class="inputdata" type="text" name="Payer" form="info1"/></td>
					<td><input class="inputdata" required type="number" name="Tel" form="info1"/></td>
					<td><input class="inputdata" required type="email" name="Email" form="info1"/></td>
					<td><input class="inputdata" required type="text" name="RealPay" form="info1"/></td>
					<td><input class="inputdata" required type="text" name="NeedPay" form="info1"/></td>
					<td><button type="button" name="del">删除</button></td>
				</tr>
			</table>
			<input id="btnAdd0" class="btnAdd" type="button" value="新增" form="info1"/>
		</div>
	</div>

</div>
<div id="delItem">删除</div>


<script type="text/javascript" >
{
	function convertToElementArray(nodes)
	{
	    var array=null;
	    array=new Array();
	    for(var i=0;i < nodes.length; i++)
	    {
	      if(nodes[i].nodeType==1)
	      {
	        array.push(nodes[i]);
	      }
	          
	    }
	    return array;
	 }

  //delete user in one item
    function deleteUser()
    {
        
      var con=confirm("确认删除整行的数据？");
      if(con)
      {
         var tr=this.parentNode.parentNode;
        tr.parentNode.removeChild(tr);
      } 
  	}

    function clickRightMenu(Id,MenuId)
  	{
    	var elem=document.getElementById("item"+Id);
    

      	EventUtil.addHandler(elem,"contextmenu",function(event){
        console.log(this);
        event=EventUtil.getEvent(event);
        EventUtil.preventDefault(event);
        var menu=document.getElementById(MenuId);
        menu.style.left=event.clientX+"px";
        menu.style.top=event.clientY+"px";
        menu.style.visibility="visible";

        console.log("src :"+event.srcElement);
        //console.log("target:"+tar);
        console.log("menu:"+menu);

        //EventUtil.addHandler(menu,"click",function(event) b??????????为啥不行
        //var menu=document.getElementById(MenuId);
        menu.onclick=function(event)
        {
          var con=confirm("确认删除整个支出项目"+Id+"的数据？");
          if(con)
          {
            //delete item
            var anch=document.getElementById("anchclList"+Id);
            console.log("num:"+Id);
            console.log("anch: "+anch);
            anch.parentNode.removeChild(anch);

            //delete nav
            var navDelete=document.getElementById("item"+Id);
            console.log("nav: "+navDelete);
            navDelete.parentNode.removeChild(navDelete);

          } 

        };

      });




		EventUtil.addHandler(document,"click",function(event)
		{
			document.getElementById(MenuId).style.visibility="hidden";
		});

	}
	/******if name has already exist, auto show Tel and Email when name change**********/
	function telEmailAutoShow(){
		var database=loadXMLDoc("fee.xml");
		if(xmldoc!=null)
    	{
    		var userInxml=xmldoc.getElementsByTagName("Payer");
    		for(var i=0;i<userInxml.length;i++)
    		{
    			var userX=userInxml[i];
    			if(this.value==userX.childNodes[0].nodeValue)  //this: input Payer
    			{
    				this.parentNode.nextSibling.firstChild.value=userX.nextElementSibling.childNodes[0].nodeValue;  //td->td->input Tel
    				this.parentNode.nextSibling.nextSibling.firstChild.value=userX.nextElementSibling.nextElementSibling.childNodes[0].nodeValue;//td->td->input Email
    				break;
    			}
    		}
    		
    	}

	}


	//var TableAdd= function(itemNum)
 var TableAdd = function()
  {
    var parent=this.parentNode;
    var childs=parent.childNodes;
    var childsArray=convertToElementArray(childs);
    var oritable=childsArray[0];

    var row=oritable.insertRow(oritable.rows.length);

    var cell0=row.insertCell(0);
    cell0.innerHTML="<input class='inputdata' type='text' name='Payer' form='info1'/>";

    var cell1=row.insertCell(1);
    cell1.innerHTML="<input class='inputdata' required type='number' name='Tel' form='info1'/>";

    var cell2=row.insertCell(2);
    cell2.innerHTML="<input class='inputdata' required type='email' name='Email' form='info1'/>";

    var cell3=row.insertCell(3);
    cell3.innerHTML="<input class='inputdata' required type='text' name='RealPay' form='info1'/>";

    var cell4=row.insertCell(4);
    cell4.innerHTML="<input class='inputdata' required type='text' name='NeedPay' form='info1'/>";
    
    var cell5=row.insertCell(5);
    cell5.innerHTML="<button type='button' name='del' >删除</button>";

    /***************add click function to delete button*******/
    var deleterow=row.lastChild.firstChild;
    EventUtil.addHandler(deleterow,"click",deleteUser);
    EventUtil.addHandler(cell0.firstChild,"change",telEmailAutoShow);


  };

    function addBtnAddCss (ElmentId)
	{
		var  btnAddCss=document.getElementById(ElmentId);
		btnAddCss.style.marginBottom="20px";
	}

    /***************add new user************/

	var btnClick=document.getElementById("btnAdd0");
	//EventUtil.addHandler(btnClick,"click",TableAdd(0));
	EventUtil.addHandler(btnClick,"click",TableAdd);
	addBtnAddCss("btnAdd0");	

	function handlerPrevent()
	{
		event= this.event || window.event;
		EventUtil.preventDefault(event);
	}
    /*****onclick submit compute total user number*******/
	var validCheck=function()
	{

		var parent = document.getElementById("infoBody");
		var childs=parent.childNodes;
		var childsArray=convertToElementArray(childs);
		var length=childsArray.length;
		EventUtil.removeHandler(document.getElementById("info1"),"submit",handlerPrevent);
		for (var i=0; i< length;i++)
		{
			var table=document.getElementById("tableInfo"+i);
			var user=document.getElementById("shareNum"+i);
			var totalFee=document.getElementById("pay"+i);
			if(user.value)
			{
				if(user.value!=table.rows.length-1)
				{
					var userNumByTableRows=table.rows.length-1
					if(confirm(document.getElementById("itemName"+i).value+"人数不匹配，请确认是否为 "+userNumByTableRows+" 人？"))
					{
						user.value=table.rows.length-1;
					}
					else
					{
						EventUtil.addHandler(document.getElementById("info1"),"submit",handlerPrevent);
						//EventUtil.removeHandler(document.getElementById("info1"),"submit",handlerPrevent);

					}
				}

			}
			else
			{
				user.value=table.rows.length-1;
			}

			var sumFee=0;
			for(var j=0;j<user.value;j++)
			{
				sumFee=parseInt(sumFee)+parseInt(document.getElementById("tableInfo"+i).rows[1+j].cells[4].firstChild.value);
			}
			if(sumFee!=totalFee.value)
			{
				alert(document.getElementById("itemName"+i).value+"费用总和不是 "+totalFee.value);
				EventUtil.addHandler(document.getElementById("info1"),"submit",handlerPrevent);
			}
			
		}


	};

	EventUtil.addHandler(document.getElementById("btnSubmit"),"click",validCheck);


	function map()
	{
		  			//
		 var str=this.id;

		 document.getElementById("infoBody").scrollTop=document.getElementById("anchclList"+str.substring(4,str.length)).offsetTop;
	}

    /*********add new item**********/
	function addContent1Css (ElmentId) {
		var  content1AddCss=document.getElementById(ElmentId);
		content1AddCss.style.background="#F0F0F0";
		content1AddCss.style.borderBottom="1px,solid,#E0E0E0";
		content1AddCss.style.padding="2px";
		content1AddCss.style.height="26px";
	}

	var click1=document.getElementById("add");

    var addNewItem = function()
    {
    			
   	    	
    	var itemname=prompt("请输入支出项目名称","");
  		if (itemname!=null && itemname!="")
    	{
    		var elm=document.getElementById("infoBody");
    		var nodeArray =convertToElementArray(elm.childNodes);
    		var count=nodeArray.length;
    		var newDiv="<div id=anchclList"+count+">"
    				+"<a name=item"+count+"></a>"
    				+"<div class=mainbody id=content1_"+count+">"
              			//+"<form id=info"+count+" action=dealwith.asp method=post/>"
             				+"支出"+count+": "
             				+"<input id=itemName"+count+" class=inputdata type=text name=item value="+itemname+" form=info1>"+"  "
             				+"总金额："
              				+"<input id=pay"+count+" class=inputdata type=text name=totalPay form=info1>"+"  总人数:"
              				+"<input id=shareNum"+count+" class=inputdata type=text name=userNum form=info1 defaultValue=可选>"+"  "
              			//+"</form>"
              		+"</div>"
              		+"<div class=mainbody id=content2_"+count+">"
              			+"<table id=tableInfo"+count+">"
              				+"<tr>"
              		    		+"<td>交款人</td>"
              		    		+"<td>电话</td>"
              		    		+"<td>邮箱</td>"
              		    		+"<td>实交款</td>"
              		    		+"<td>需交款</td>"
              		    	+"</tr>"
              				+"<tr>"
              					+"<td><input class=inputdata type=text name=Payer form=info1></td>"
              					+"<td><input class=inputdata required type=number name=Tel form=info1></td>"
              					+"<td><input class=inputdata required type=email name=Email form=info1></td>"
              					+"<td><input class=inputdata required type=text name=RealPay form=info1></td>"
              					+"<td><input class=inputdata required type=text name=NeedPay form=info1></td>"
              					+"<td><button type=button name=del >删除</button></td>"
              				+"</tr>"
              			+"</table>"
              			+"<input id=btnAdd"+count+" class=btnAdd type=button value=新增 form=info1>"
              		+"</div>"

              	+"</div>";

			//append behind infoBody
			elm.insertAdjacentHTML("beforeEnd", newDiv); 

			//add item in Navigator
			var nav=document.getElementById("menu");
			var menuConvert=convertToElementArray(nav.childNodes);
		  	var menuLen=menuConvert.length;

		  	convertToElementArray(elm.childNodes);
		  	var newNav="<li id=item"+menuLen+"><a href=#item"+menuLen+">"+itemname+"</a></li>";
		  	nav.insertAdjacentHTML("beforeEnd",newNav);

		  	//window.location.href="#item"+menuLen;
		  	if(count>1)
		  	{
		  		//document.getElementById("anchclList"+count).style.marginBottom=0;
		  		var cnt=count-1;
		  		addBtnAddCss("btnAdd"+cnt);
		  	}

		  	//when add a item, this item can be showed on the top of anchclList
		  	document.getElementById("btnAdd"+count).style.marginBottom="500px";
		  	document.getElementById("infoBody").scrollTop=document.getElementById("anchclList"+count).offsetTop;

		  	EventUtil.addHandler(document.getElementById("item"+menuLen),"click",map);

		  	if(count>6)
		    {
		    	//document.getElementById("menuNav").style.width=(parseInt(count/7)+parseInt(1))*100%;

		    	document.getElementById("menu").style.width=parseInt(Math.ceil(count/6))*28+"em";
		    }


			/*right click to delete new item************/	
			clickRightMenu(menuLen,"delItem");  	  	

		  	//bound with event
		  	var firstUser=document.getElementById("tableInfo"+count).rows[1].cells[0];
		  	EventUtil.addHandler(firstUser.firstChild,"change",telEmailAutoShow);
		  	var btnAddClic=document.getElementById("btnAdd"+count);
		  	EventUtil.addHandler(btnAddClic,"click",TableAdd);


			/***************delete new user************/
			var table=document.getElementById("tableInfo"+count);
			var childs=convertToElementArray(table.childNodes);

			var deleterow=childs[0].lastChild.lastChild;
			console.log("del: "+deleterow);
			EventUtil.addHandler(deleterow,"click",deleteUser);	

			//add CSS 
			addContent1Css("content1_"+count);
			



    	}
    	else
    	{
    		alert("取消新增支出项目");
    	}

    	
    };

    EventUtil.addHandler(click1,"click",addNewItem); 


	 //****************display the haved items*****************

    var xmldoc=loadXMLDoc("fee.xml");
    if(xmldoc!=null)
    {
	    var x=xmldoc.getElementsByTagName("item");
	    if(x.length>0)  // for in item
	    {
	    	
	    	var m,n,xmlTable,k,name;
	    	for(var i=0; i<x.length;i++)
	    	{
	    		if(i!=0)
	    		{
		  			var count=i;
		    		var elm=document.getElementById("infoBody");
		    		var nodeArray =convertToElementArray(elm.childNodes);
		    		var count=nodeArray.length;

		    		var newDiv="<div id=anchclList"+count+">"
		    				+"<a name=item"+count+"></a>"
	    				+"<div class=mainbody id=content1_"+count+">"
	              			//+"<form id=info"+count+" action=dealwith.asp method=post/>"
	             				+"支出"+count+": "
	             				+"<input id=itemName"+count+" class=inputdata type=text name=item form=info1>"+"  "
	             				+"总金额："
	              				+"<input id=pay"+count+" class=inputdata type=text name=totalPay form=info1>"+"  总人数:"
	              				+"<input id=shareNum"+count+" class=inputdata type=text name=userNum form=info1>"+"  "
	              			//+"</form>"
	              		+"</div>"
	              		+"<div class=mainbody id=content2_"+count+">"
	              			+"<table id=tableInfo"+count+">"
	              				+"<tr>"
	              		    		+"<td>交款人</td>"
	              		    		+"<td>电话</td>"
	              		    		+"<td>邮箱</td>"
	              		    		+"<td>实交款</td>"
	              		    		+"<td>需交款</td>"
	              		    	+"</tr>"
	              				+"<tr>"
	              					+"<td><input class=inputdata type=text name=Payer form=info1></td>"
	              					+"<td><input class=inputdata required type=number name=Tel form=info1></td>"
	              					+"<td><input class=inputdata required type=email name=Email form=info1></td>"
	              					+"<td><input class=inputdata required type=text name=RealPay form=info1></td>"
	              					+"<td><input class=inputdata required type=text name=NeedPay form=info1></td>"
	              					+"<td><button type=button name=del >删除</button></td>"
	              				+"</tr>"
	              			+"</table>"
	              			+"<input id=btnAdd"+count+" class=btnAdd type=button value=新增 form=info1>"
	              		+"</div>"

	              	+"</div>";

					//append behind infoBody
					elm.insertAdjacentHTML("beforeEnd", newDiv); 

					//add item in Navigator
					var nav=document.getElementById("menu");
				  	var menuConvert=convertToElementArray(nav.childNodes);
				  	var menuLen=menuConvert.length;
				  	var newNav="<li id=item"+menuLen+"><a href=#item"+menuLen+">"+x[i].childNodes[0].nodeValue+"</a></li>";
				  	nav.insertAdjacentHTML("beforeEnd",newNav);
				  	//window.location.href="#item"+count;

				  

				  	//when click nav, related item can be showed on the top of anchclList
				  	if(menuLen==(x.length-1))
				  	{
				  		document.getElementById("btnAdd"+count).style.marginBottom="500px";
				  	
				  	}
				  	else
				  	{
				  		addBtnAddCss("btnAdd"+count);
				  	}
		  			 			
		  			
				  	
				  	//add content1 CSS 
					addContent1Css("content1_"+count);
					

					clickRightMenu(menuLen,"delItem");

				  	//bound with event
				  	var btnAddClic=document.getElementById("btnAdd"+count);
				  	EventUtil.addHandler(btnAddClic,"click",TableAdd);


				}
				EventUtil.addHandler(document.getElementById("item"+i),"click",map);

		    	m=document.getElementById("itemName"+i);
			   	m.value=x[i].childNodes[0].nodeValue;

		    	n=document.getElementById("pay"+i);
		    	n.value=x[i].childNodes[1].firstChild.nodeValue;

				xmlTable=xmldoc.getElementsByTagName("person");
		    	userN=document.getElementById("shareNum"+i);
		    	userN.value=xmlTable[i].childNodes[0].nodeValue;
		  		
		    	k=xmlTable[i].childNodes[0].nodeValue-1;

		    	//add users
		    	while(k--)
			   	{
					var oritable=document.getElementById("tableInfo"+i);

					var row=oritable.insertRow(oritable.rows.length);

					var cell0=row.insertCell(0);
					cell0.innerHTML="<input class='inputdata' type='text' name='Payer' form='info1'/>";

					var cell1=row.insertCell(1);
					cell1.innerHTML="<input class='inputdata' required type='number' name='Tel' form='info1'/>";

					var cell2=row.insertCell(2);
					cell2.innerHTML="<input class='inputdata' required type='email' name='Email' form='info1'/>";

					var cell3=row.insertCell(3);
					cell3.innerHTML="<input class='inputdata' type='text' name='RealPay' form='info1'/>";

					var cell4=row.insertCell(4);
					cell4.innerHTML="<input class='inputdata' type='text' name='NeedPay' form='info1'/>";

					var cell5=row.insertCell(5);
					cell5.innerHTML="<button type='button' name='del'>删除</button>";
					   	
			   	}

			   	var htmlTable=document.getElementById("tableInfo"+i);
			   	var htmlUser=document.getElementsByName("Payer");
			   	var i1=0,j1=0;
				for (i1=0;i1<userN.value;i1++)  // usesrs
				{
					for(j1=0;j1<5;j1++)  //five cells every user
					{
					   	var xx=xmlTable[i].childNodes[j1+1+5*i1];
					   	htmlTable.rows[i1+1].cells[j1].firstChild.value=xx.childNodes[0].nodeValue;
					}

					EventUtil.addHandler(htmlUser[i1],"change",telEmailAutoShow);
				} 


			    		    
	    	}
	    }

	    if(x.length>7)
	    {
	    	document.getElementById("menu").style.width=parseInt(Math.ceil(x.length/6))*28+"em";
	    }
	}

}


	/***************delete new user************/
	var dele=document.getElementsByName("del");
    for(var i=0;i<dele.length;i++)
    {
		EventUtil.addHandler(dele[i],"click",deleteUser);
    }

	

</script>
	



<footer>
	<p> maintained by Shirley</p>
</footer>
</body>

</html>

